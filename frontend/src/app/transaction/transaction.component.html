<main class="transactions">

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ header + mode switch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <header class="tx-header">
    <h1>Transactions</h1>
  </header>
  <!-- mode switch -->
  <div class="segmented">
    <button (click)="setMode('list')" [class.active]="mode==='list'">List</button>
    <button (click)="setMode('calendar')" [class.active]="mode==='calendar'">Calendar</button>
  </div>


  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ filters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <section class="filters card--glass" *ngIf="mode==='list'">
    <input class="search" placeholder="Search‚Ä¶" [(ngModel)]="searchTxt" (input)="recalcView()">
    <div class="grid">
      <div class="field">
        <label>Type</label>
        <select [(ngModel)]="f.type" (change)="recalcView()">
          <option value="">All</option>
          <option value="expense">Expense</option>
          <option value="income">Income</option>
        </select>
      </div>
      <div class="field"><label>From</label><input type="date" [(ngModel)]="f.from" (change)="recalcView()"></div>
      <div class="field"><label>To</label><input type="date" [(ngModel)]="f.to" (change)="recalcView()"></div>
      <div class="field"><label>Min ‚Ç¨</label><input type="number" [(ngModel)]="f.min" (input)="recalcView()"></div>
      <div class="field"><label>Max ‚Ç¨</label><input type="number" [(ngModel)]="f.max" (input)="recalcView()"></div>
      <div class="field toggle">
        <label><input type="checkbox" [(ngModel)]="f.recurring" (change)="recalcView()"> Recurring</label>
      </div>
      <button class="btn-reset" (click)="clearFilters()">Reset</button>
    </div>
  </section>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ calendar view ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <app-calendar-view *ngIf="mode==='calendar'" [transactions]="viewTx" (openTx)="openView($event)"
    (openDay)="handleDatePick($event)">
  </app-calendar-view>


  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ list view ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <section class="tx-list" *ngIf="mode==='list'">
    <nav class="pagination" *ngIf="displayPages>1">
      <button (click)="prevPage()" [disabled]="currentPage===0">‚óÄ</button>
      <span>Page {{currentPage+1}} / {{displayPages}}</span>
      <button (click)="nextPage()" [disabled]="currentPage+1>=displayPages">‚ñ∂</button>
    </nav>

    <ng-container *ngFor="let day of groupKeys">
      <div class="day-chip">{{day}}</div>
      <div class="tx-card" *ngFor="let t of groups[day]" [class.expense]="t.type==='expense'"
        [class.income]="t.type==='income'" (click)="openView(t)">
        <span class="icon">{{t.categoryIcon}}</span>

        <div class="info">
          <strong class="cat">{{t.category}}</strong>
          <small class="sub" *ngIf="t.note">{{t.note}}</small>
          <small class="sub" *ngIf="t.planned">planned</small>
        </div>

        <div class="meta">
          <span class="amount">‚Ç¨{{t.amount | number:'1.2-2'}}</span>
          <small>{{t.date | date:'shortTime'}}</small>
          <div class="row-btns" (click)="$event.stopPropagation()">
            <button class="icn icn-edit" (click)="openEdit(t)">‚úé</button>
            <button class="icn icn-delete" (click)="openDelete(t)">üóëÔ∏è</button>
          </div>
        </div>
      </div>
    </ng-container>
  </section>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Floating-action button ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="fab-container" [class.open]="fabOpen">
    <button class="fab-main" (click)="fabOpen=!fabOpen">Ôºã</button>
    <div class="fab-actions">
      <button class="fab-action" (click)="addTx()" title="Add tx">üìù</button>
      <button class="fab-action" (click)="addPlanned()" title="Planned">üìÖ</button>
      <button class="fab-action" (click)="pdfInput.click()" title="Import Revolut">
        <img src="assets/icons/revolut.png" alt="R">
      </button>
    </div>
    <input #pdfInput type="file" accept="application/pdf" hidden (change)="handlePdfChosen($event)">
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="modal-backdrop" *ngIf="modalMode!=='view' || selected">
    <div class="tx-modal">
      <button class="btn-x" (click)="closeModal()">√ó</button>

      <!-- VIEW -->
      <ng-container *ngIf="modalMode==='view' && selected">
        <h2>Transaction</h2>
        <p><strong>{{selected.category}}:</strong> {{selected.amount|currency}}</p>


        <!-- choose the style you prefer -->
        <p><strong>Date: </strong> {{ selected.date | date:'yyyy-MM-dd HH:mm' }}</p>

        <p *ngIf="selected.note">{{selected.note}}</p>
        <div class="modal-actions">
          <button (click)="openEdit(selected)">Edit</button>
          <button (click)="openDelete(selected)">Delete</button>
        </div>
      </ng-container>

      <!-- DELETE -->
      <ng-container *ngIf="modalMode==='delete' && selected">
        <h2>Delete?</h2>
        <p>Delete <strong>{{selected.category}}</strong> ‚Äì ‚Ç¨{{selected.amount}} ?</p>
        <div class="modal-actions">
          <button (click)="closeModal()">Cancel</button>
          <button class="danger" (click)="confirmDelete()">Delete</button>
        </div>
      </ng-container>

      <!-- EDIT / NEW -->
      <form *ngIf="isEdit() || isNew()" #frm="ngForm" (ngSubmit)="isEdit() ? saveEdit(frm) : saveNew(frm)">

        <h2>
          {{
          modalMode==='quickEdit' ? 'Quick edit' :
          modalMode==='fullEdit' ? 'Edit transaction' :
          modalMode==='planEdit' ? 'Edit planned' :
          modalMode==='newTx' ? 'New transaction' : 'New planned'
          }}
        </h2>

        <!-- show spinner while waiting for payload -->
        <p *ngIf="loadingEdit" class="loading">Loading‚Ä¶</p>

        <!-- AMOUNT -->
        <input name="amount" type="number" min="0.01" step="0.01" [(ngModel)]="editForm.amount" required>

        <!-- CATEGORY -->
        <select name="categoryId" [(ngModel)]="editForm.categoryId" required>
          <option [ngValue]="null" disabled>Select category</option>
          <option *ngFor="let c of categories" [value]="c.id">{{c.name}}</option>
        </select>

        <!-- TITLE (planned only) -->
        <input *ngIf="modalMode==='planEdit' || modalMode==='newPlan'" name="title" [(ngModel)]="editForm.title"
          placeholder="Title" required>

        <!-- TYPE -->
        <select *ngIf="modalMode!=='quickEdit'" name="type" [(ngModel)]="editForm.type" required>
          <option value="expense">Expense</option>
          <option value="income">Income</option>
        </select>

        <!-- DATE -->
        <input *ngIf="modalMode!=='quickEdit'" name="date"
          [type]="modalMode==='planEdit' || modalMode==='newPlan' ? 'date' : 'datetime-local'"
          [(ngModel)]="editForm.date" required>

        <!-- USE-GEO checkbox (all non-planned tx) -->
        <div class="field checkbox-row" *ngIf="modalMode!=='planEdit' && modalMode!=='newPlan' && isNew()">
          <label>
            <input type="checkbox" [(ngModel)]="editForm.useGeo" name="useGeo">
            <span>Use my location</span>
          </label>
        </div>

        <!-- NOTE -->
        <textarea *ngIf="modalMode!=='quickEdit'" name="note" [(ngModel)]="editForm.note" placeholder="Note"></textarea>

        <div class="modal-actions">
          <button type="button" (click)="closeModal()">Cancel</button>
          <button type="submit" [disabled]="frm.invalid || loadingEdit">Save</button>
        </div>
      </form>

    </div>
  </div>

</main>