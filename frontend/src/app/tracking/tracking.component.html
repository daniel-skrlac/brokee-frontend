<main class="tracking">
  <h1>Statistics</h1>
  <!-- CASH‑FLOW FUNNEL -->
  <section class="card funnel-section">
    <h2>Cash-Flow Funnel In Current Year</h2>
    <canvas baseChart [data]="funnelData" [options]="funnelOpts" chartType="bar">
    </canvas>
  </section>

  <!-- SAVINGS RATE GAUGE -->
  <section class="card gauge-section">
    <h2>Savings Rate</h2>
    <div class="gauge-wrapper">
      <canvas baseChart [data]="gaugeData" [options]="gaugeOpts" chartType="doughnut">
      </canvas>
      <div class="gauge-center">
        <div class="gauge-value">{{ savingsRate }}%</div>
        <div class="gauge-label">of income</div>
      </div>
    </div>
  </section>

  <!-- TOP 3 SPENDING LOCATIONS MAP SLIDER -->
  <ng-container *ngIf="topLocations?.length; else noLocations">
    <section class="card map-section">
      <h2>Top 3 Spending Locations</h2>
      <div id="clusterMap" #mapEl class="map"></div>
      <div class="map-controls">
        <button class="btn-square" (click)="prevLocation()">◀</button>
        <span>{{ topLocations[currentLocIdx].label }}</span>
        <button class="btn-square" (click)="nextLocation()">▶</button>
      </div>
    </section>
  </ng-container>

  <ng-template #noLocations>
    <section class="card map-section">
      <h2>Top 3 Spending Locations</h2>
      <div class="no-data">
        There are no locations to be shown.
      </div>
    </section>
  </ng-template>

  <!-- 30‑DAY ROLLING AVERAGE SPARKLINE -->
  <section class="card chart-section rolling-avg">
    <h2>30-Day Avg Spend</h2>
    <canvas baseChart [data]="rollingAvgData" [options]="rollingAvgOpts" type="line" #rollingAvgChart>
    </canvas>
  </section>


  <!-- CALENDAR HEATMAP -->
  <section class="calendar-heatmap">
    <h2>Spending Heatmap</h2>
    <div class="heatmap-grid">
      <div *ngFor="let d of heatmapData" [class]="'day level-' + d.level">
      </div>
    </div>
    <div class="weekdays">
      <div>Sun</div>
      <div>Mon</div>
      <div>Tue</div>
      <div>Wed</div>
      <div>Thu</div>
      <div>Fri</div>
      <div>Sat</div>
    </div>
  </section>

  <!-- SPENDING VS INCOME BAR CHART -->
  <section class="card chart-section">
    <h2>Spending vs Income</h2>
    <canvas baseChart [data]="spendingIncomeData" [options]="spendingIncomeOpts" chartType="bar">
    </canvas>
  </section>

  <!-- CATEGORY BREAKDOWN -->
  <section class="card chart-section">
    <h2>Category Breakdown</h2>
    <canvas baseChart [data]="categoryBarData" [options]="categoryBarOpts" chartType="bar">
    </canvas>
  </section>

  <!-- FLOATING BINANCE BUTTON -->
  <button class="crypto-btn binance-btn" [disabled]="!hasBinance" (click)="openBinanceModal()"
    title="View Binance Portfolio" width="100%" height="100%">
    <img src="assets/icons/binance.png" alt="Binance" />
  </button>

  <!-- BINANCE PORTFOLIO MODAL -->
  <div class="modal-backdrop" *ngIf="showBinanceModal">
    <div class="modal crypto-modal scrollable" style="height: 600px;">
      <button class="btn-x" (click)="closeBinanceModal()">x</button>

      <h2>Your Binance Portfolio</h2>

      <div *ngIf="!portfolio">
        <p class="loading">Loading…</p>
      </div>

      <div *ngIf="portfolio">
        <p class="modal__subtitle">
          Total Value: {{ portfolio.totalEurValue | currency:userCurrency }}
        </p>

        <div class="modal-body">
          <h3>Top Market Movers</h3>
          <table class="binance-table">
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Price</th>
                <th>Δ %</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let coin of portfolio.topMarketCoins">
                <td>{{ coin.symbol }}</td>
                <td>{{ coin.lastPrice | number:'1.2-2' }}</td>
                <td [class.positive]="coin.priceChangePercent >= 0" [class.negative]="coin.priceChangePercent < 0">
                  {{ coin.priceChangePercent | number:'1.2-2' }}%
                </td>
              </tr>
            </tbody>
          </table>

          <h3>My Holdings</h3>
          <table class="binance-table">
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Free</th>
                <th>Locked</th>
                <th>Value ({{ userCurrency }})</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let entry of portfolio.myCoins">
                <tr>
                  <td>{{ entry.symbol }}</td>
                  <td>{{ entry.free }}</td>
                  <td>{{ entry.locked }}</td>
                  <td>{{ entry.eurValue | number:'1.2-2' }}</td>
                </tr>
                <!-- 5 most recent trades for this symbol -->
                <tr class="trade-row">
                  <td colspan="4">
                    <div class="trade-header">Recent trades for {{ entry.symbol }}:</div>
                    <table class="trade-table">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Side</th>
                          <th>Price</th>
                          <th>Qty</th>
                          <th>Time</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let t of entry.trades | slice:0:5">
                          <td>{{ t.id }}</td>
                          <td [class.buyer]="t.isBuyer" [class.seller]="!t.isBuyer">
                            {{ t.isBuyer ? 'Buy' : 'Sell' }}
                          </td>
                          <td>{{ t.price }}</td>
                          <td>{{ t.qty }}</td>
                          <td>{{ t.time | date:'shortTime' }}</td>
                        </tr>
                        <tr *ngIf="(entry.trades?.length || 0) === 0">
                          <td colspan="5" class="no-trades">No recent trades</td>
                        </tr>
                      </tbody>
                    </table>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>

        </div>
      </div>
    </div>
  </div>
</main>